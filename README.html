<h1 id="notify-backend">Notify-backend</h1>
<p>Backend for notification system for the VcA Pool² statem. Collects notification data from connected Microservices and sends them to frontend widget our directly to the users via Third-party tools (Telegram, Mail, Push, ...).</p>
<p>Consist of: Mogodb Database Node.js App</p>
<p>both running in docker container</p>
<h1 id="build-status">Build status</h1>
<p><a href="https://travis-ci.org/rwieruch/node-express-server-rest-api"><embed src="https://travis-ci.org/rwieruch/node-express-server-rest-api.svg?branch=master" /></a> <a href="https://slack-the-road-to-learn-react.wieruch.com/"><img src="https://slack-the-road-to-learn-react.wieruch.com/badge.svg" alt="Slack" /></a> <a href="https://greenkeeper.io/"><img src="https://badges.greenkeeper.io/rwieruch/node-express-server-rest-api.svg" alt="Greenkeeper badge" /></a></p>
<h2 id="features">Features</h2>
<ul>
<li>REST API</li>
<li>NATS server</li>
<li>MongoDB</li>
<li>REDIS</li>
</ul>
<h2 id="requirements">Requirements</h2>
<p>For user authentication:</p>
<ul>
<li>Running redis-api nats-api and nginx-api from https://github.com/Viva-con-Agua/api-deploy</li>
<li>Running drops-backend and drops-database from https://github.com/Viva-con-Agua/drops-backend</li>
</ul>
<p>(For testing purposes - user authentication can be done locally (See: ))</p>
<h2 id="installation">Installation</h2>
<p>For Development:</p>
<ul>
<li><p>git clone https://github.com/Viva-con-Agua/notify-backend</p></li>
<li><p>start MongoDB Database</p></li>
<li>run on local server or with docker: docker-compose up notify-database</li>
<li>MongoDB should be running on port 27017 with credentials username = notify password = notify</li>
<li><p>check if database is running correctly by trying to connect to it (for example with MongoDB Compass)</p></li>
<li><p>start Nats, Redis and Nginx server</p></li>
<li><p>run docker-compose up nats-api redis-api nginx-api on https://github.com/Viva-con-Agua/api-deploy project</p></li>
<li><p>start drops backend and database</p></li>
<li><p>run docker-compose up on https://github.com/Viva-con-Agua/drops-backend project</p></li>
<li>npm install</li>
<li><p>change config/development.env to .env and change values if your database or anything else is running on different ports</p></li>
<li><p>npm run dev</p></li>
</ul>
<p>If you want to run the backend without authentification from drops work with branch 'without_authentification'. There you work with an Mongo dump with an example user and have an own running nats server in docker-compose.</p>
<h2 id="set-up-new-microservice">Set up new Microservice</h2>
<p>It is recommended to use the SETUP functionalityy of vca_widget_notify to set up a Microservie and configure what notifications should be handled in which manner.</p>
<ol style="list-style-type: decimal">
<li>Your Microservice needs an REST API Endpoint which provides the following array of notifications: [{ <b>Microservice: </b>name of Service, <b>type: </b>type of Notification*,<br /> <b>date: </b>current date and time, <b>validTill: </b>when the notification becomes irrelevant, <b>typeId: </b>id which together with type should make the notification unique, <b>layoutParameters: </b>parameters needed for displaying all important information, <b>matchingParameters: </b>parameters needed for matching the notification to interested users }]</li>
</ol>
<p>for an example see: https://github.com/Viva-con-Agua/waves-backend/blob/notify/controller/notificationController.js</p>
<ol start="2" style="list-style-type: decimal">
<li>Test if the API is reachable and the data has the correct format</li>
</ol>
<p>POST /TestAPI { 'name': <span class="math"><em>M</em><em>i</em><em>c</em><em>r</em><em>o</em><em>s</em><em>e</em><em>r</em><em>v</em><em>i</em><em>c</em><em>e</em><sub><em>n</em></sub><em>a</em><em>m</em><em>e</em>, ʹ<em>a</em><em>p</em><em>i</em>ʹ : </span>Microservice_api, }</p>
<p>if everything is correct, the Microservice will be saved in database as an Notification endpoint (collection: 'microservices')</p>
<ol start="3" style="list-style-type: decimal">
<li>Set categories for your notification types</li>
</ol>
<p>POST /saveCategories { 'Microservice': <span class="math">$Microservice_name,     'types': [{$</span>type: ( &quot;Aktionen&quot; || &quot;Crew Info &amp; Soziales&quot; || &quot;Spenden &amp; Projekte&quot;) }], }</p>
<ol start="4" style="list-style-type: decimal">
<li>Set Pipelines over which the users can subsribe to your notifications</li>
</ol>
<p>POST /saveConditions { Microservice: <span class="math">$Microservice_name,               conditions: [{$</span>type: <span class="math">$pipeline_data}],               types: [$</span>types ], missing: [$pipelines you wnat to delete], }</p>
<p>All setup functions are in /controller/settingscontroller.js</p>
<h3 id="example-configuration">Example configuration</h3>
<p>If you want a example configuration, in config sql-dumps is one for WAVES as an Microservice that sends notifications to notify.</p>
<ul>
<li>start the waves-backend https://github.com/Viva-con-Agua/waves-backend from branch Nicola and load the sql_dump there</li>
</ul>
<h2 id="set-up-user">Set up user</h2>
<h3 id="nats-subscribtions">NATS Subscribtions</h3>
<p>( topic: 'notification', msg: <span class="math"><em>M</em><em>i</em><em>c</em><em>r</em><em>o</em><em>s</em><em>e</em><em>r</em><em>v</em><em>i</em><em>c</em><em>e</em><sub><em>n</em></sub><em>a</em><em>m</em><em>e</em>)<em>w</em><em>i</em><em>l</em><em>l</em><em>t</em><em>r</em><em>i</em><em>g</em><em>g</em><em>e</em><em>r</em><em>t</em><em>h</em><em>e</em><em>u</em><em>p</em><em>d</em><em>a</em><em>t</em><em>e</em><em>e</em><em>v</em><em>e</em><em>n</em><em>t</em><em>a</em><em>n</em><em>d</em><em>N</em><em>O</em><em>T</em><em>I</em><em>F</em><em>Y</em><em>w</em><em>i</em><em>l</em><em>l</em><em>s</em><em>e</em><em>n</em><em>d</em><em>o</em><em>u</em><em>t</em><em>a</em><em>G</em><em>E</em><em>T</em><em>r</em><em>e</em><em>q</em><em>u</em><em>e</em><em>s</em><em>t</em><em>t</em><em>o</em><em>t</em><em>h</em><em>e</em><em>A</em><em>P</em><em>I</em><em>s</em><em>a</em><em>v</em><em>e</em><em>d</em><em>i</em><em>n</em><em>D</em><em>a</em><em>t</em><em>a</em><em>b</em><em>a</em><em>s</em><em>e</em>ʹ<em>m</em><em>i</em><em>c</em><em>r</em><em>o</em><em>s</em><em>e</em><em>r</em><em>v</em><em>i</em><em>c</em><em>e</em><em>s</em>ʹ<em>c</em><em>o</em><em>l</em><em>l</em><em>e</em><em>c</em><em>t</em><em>i</em><em>o</em><em>n</em><em>w</em><em>i</em><em>t</em><em>h</em>ʹ<em>n</em><em>a</em><em>m</em><em>e</em>ʹ = </span>Microservice_name.</p>
<p>This data is stored in the 'notifications' collection and send them out to subscribed users after a set amount of time.</p>
<h3 id="get-routes">GET Routes</h3>
<p>ALL behind authentification function Send { headers: { Authorization: <code>Bearer $access_token</code> } with correct access_token saved in database-&gt;'users'</p>
<p>GET /filter -&gt; get all filter pipelines for all microservices</p>
<p>GET /apis -&gt; get all currently usable apis</p>
<p>GET /notifications -&gt; get all stored notifications</p>
<p>GET /user</p>
<p>GET /oauth</p>
<p>GET /sendOutNotifications</p>
<h3 id="post-routes">POST Routes</h3>
<p>ALL behind authentification function Send { headers: { Authorization: <code>Bearer $access_token</code> } with correct access_token saved in database-&gt;'users'</p>
<p>POST /testAPI POST /saveCategories POST /saveConditions Setup Notifcation endpoints (see: Set up New Microservice)</p>
<p>POST /updateStatus -&gt; change notification status for chosen user in collection 'user_notifications'</p>
<p>POST /info</p>
<p>POST /updateUser</p>
